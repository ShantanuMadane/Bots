   var deposit_corousel={
      "type": "catalogue",
      "msgid": "deposit_cat",
      "items": [{
        "title": "Shubhashish Deposit",
        "subtitle": "Recurring Deposit & Reinvestment ",
        "imgurl": "http://res.cloudinary.com/gupshup/image/upload/v1482929941/Shubhashish_Deposit_bqxkgx.png",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }

        ]
      }, 
      {
        "title": "Mukta Deposit",
        "subtitle": "Fixed Deposit",
        "imgurl": "http://www.janatabankpune.com/Encyc/2013/10/12/354_04_01_57_Muk_topimage_new__H@@IGHT_129_W@@IDTH_478.jpg",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }
        ]
      },
      {
        "title": "Recurring Deposit Scheme",
        "subtitle": "Recurring Deposit ",
        "imgurl": "http://www.janatabankpune.com/Encyc/2013/10/12/354_03_11_24_Rec_topimage_new__H@@IGHT_129_W@@IDTH_478.jpg",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }]
      },
      {
        "title": "Janahit Deposit",
        "subtitle": "Savings + Fixed Deposit",
        "imgurl": "http://www.janatabankpune.com/Encyc/2013/10/12/354_03_03_26_Jan_topimage_new__H@@IGHT_129_W@@IDTH_478.jpg",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }]
      },


      ]
    };
    var loan_carousel={
      "type": "catalogue",
      "msgid": "loan_cat",
      "items": [
     {
        "title": "Janata Udyam Vikas",
        "subtitle": "Business Loan",
        "imgurl": "http://www.janatabankpune.com/Encyc/2013/10/14/354_10_58_08_u_topimage_new__H@@IGHT_129_W@@IDTH_478.jpg",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }]
      },

      {
        "title": "Janata Gold",
        "subtitle": "Gold Loan",
        "imgurl": "http://www.janatabankpune.com/Encyc/2013/10/14/354_11_07_48_gold_l_top_image__H@@IGHT_129_W@@IDTH_478.jpg",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }

        ]
      }, 
      {
        "title": "Janata Paryatan",
        "subtitle": "Travel Loan",
        "imgurl": "http://www.janatabankpune.com/Encyc/2013/10/14/354_10_54_39_parya_l_topimage_new__H@@IGHT_129_W@@IDTH_478.jpg",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }]
      }
      ]
    };
   var apply_main={
      "type": "quick_reply",
      "content": {
          "type": "text",
          "text": "  "
      },
      "msgid": "main_apply_222",
      "options": [
          "Apply now",
          "Main menu",
          
      ]
  };
  var bank_location_corousel={
      "type": "catalogue",
      "msgid": "bank_location_cat",
      "items": [{
        "title": "The Karad Janta Sahakari Bank Limited",
        "subtitle": "100/101, Ghole Rd, Shivajinagar, Pune, Maharashtra 411005",
        "imgurl": "http://www.picserver.org/images/highway/phrases/bank.jpg",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }

        ]
      }, 
      {
        "title": "Janata Sahakari Bank",
        "subtitle": "S.No. 26/20/1A, Hingane Khurd, Near Joshi Wadewale,, Sinhagad Rd, Pune, Maharashtra 411051",
        "imgurl": "http://www.picserver.org/images/highway/phrases/bank.jpg",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }
        ]
      },
      {
        "title": "Janata Sahakari Bank",
        "subtitle": "1444, Shukrawar Peth, Thorale Bajirao Road, Pune, Maharashtra 411002",
        "imgurl": "http://www.picserver.org/images/highway/phrases/bank.jpg",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }]
      },
      {
        "title": "Janata Sahakari Bank",
        "subtitle": "Abasaheb Garware College Compound, Karve Road, Deccan Gymkhana, Pune, Maharashtra 411004",
        "imgurl": "http://www.picserver.org/images/highway/phrases/bank.jpg",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }]
      },
      {
        "title": "Janata Sahakari Bank",
        "subtitle": "Jhansi Rani Laxmi Bai Chowk, Ghole Rd, Shivajinagar, Pune, Maharashtra 411005",
        "imgurl": "http://www.picserver.org/images/highway/phrases/bank.jpg",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }]
      },


      ]
    };
    var bank_atm_carousel={
      "type": "catalogue",
      "msgid": "bank_atm_cat",
      "items": [
      {
        "title": "Janata Sahakari Bank",
        "subtitle": "S.No. 26/20/1A, Hingane Khurd, Near Joshi Wadewale,, Sinhagad Rd, Pune, Maharashtra 411051",
        "imgurl": "https://upload.wikimedia.org/wikipedia/commons/d/d3/49024-SOS-ATM.JPG",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }

        ]
      }, 
     {
        "title": "Janata Sahakari Bank",
        "subtitle": "1444, Shukrawar Peth, Thorale Bajirao Road, Pune, Maharashtra 411002",
        "imgurl": "https://upload.wikimedia.org/wikipedia/commons/d/d3/49024-SOS-ATM.JPG",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }

        ]
      }, 
     {
        "title": "Janata Sahakari Bank",
        "subtitle": "Abasaheb Garware College Compound, Karve Road, Deccan Gymkhana, Pune, Maharashtra 411004",
        "imgurl": "https://upload.wikimedia.org/wikipedia/commons/d/d3/49024-SOS-ATM.JPG",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }

        ]
      }, 
      {
        "title": "Janata Sahakari Bank",
        "subtitle": "Jhansi Rani Laxmi Bai Chowk, Ghole Rd, Shivajinagar, Pune, Maharashtra 411005",
        "imgurl": "https://upload.wikimedia.org/wikipedia/commons/d/d3/49024-SOS-ATM.JPG",
        "options": [
        {
          "type": "text",
          "title": "Know More"
        }

        ]
      }, 

      ]
    };
 var nlpToken = "1d5a27b9494e47db8340f716fbb5e29f";//Your API.ai token
  /** This is a sample code for your bot**/
  function MessageHandler(context, event) {
      
      // context.sendResponse(JSON.stringify(event));
      var botname = event.botname;
      var contextobj = JSON.stringify(event.contextobj);
      var message=event.message.toLowerCase();

      if (event.messageobj.refmsgid == "tasks_101") {
        context.simpledb.roomleveldata.state="start_msg";
        context.simpledb.saveData();
      }
      if (event.messageobj.refmsgid == "products_201") {
        context.simpledb.roomleveldata.state="product_info";
        context.simpledb.saveData();
      }
      if (event.messageobj.refmsgid == "branch_locator_301") {
        context.simpledb.roomleveldata.state="branch_locator";
        context.simpledb.saveData();
      }
      if (event.messageobj.refmsgid == "deposit_cat") {
        context.simpledb.roomleveldata.state="deposit_forms";
        context.simpledb.saveData();
      }
      if (event.messageobj.refmsgid == "loan_cat") {
        context.simpledb.roomleveldata.state="loan_forms";
        context.simpledb.saveData();
      }
      
      if (event.messageobj.refmsgid == "main_apply_222") {
        context.simpledb.roomleveldata.state="main_apply";
        context.simpledb.saveData();
      }
     
      if (event.messageobj.refmsgid == "bank_location_cat") {
        context.simpledb.roomleveldata.state="bank_locations";
        context.simpledb.saveData();
      }
      if (event.messageobj.refmsgid == "bank_atm_cat") {
        context.simpledb.roomleveldata.state="bank_atm";
        context.simpledb.saveData();
      }
      if(context.simpledb.roomleveldata.state=="start_msg"){
       if(message=="product info"){
        var product={
          "type": "survey",
          "question": "Select a product to know about it",
          "msgid": "products_201",
          "options": [
          "Deposit Schemes",
          "Loan Schemes"
          ]
        }
        context.simpledb.roomleveldata.state="product_info";
        context.sendResponse(JSON.stringify(product));  

      }
      else if(message=="locate branch/atm"){
        var branch_locator={
         "type": "survey",
         "question": "Branch Locator",
         "msgid": "branch_locator_301",
         "options": [
         "Branch Location",
         "ATM" 
         ]
       }
       context.simpledb.roomleveldata.state="branch_locator";
       context.sendResponse(JSON.stringify(branch_locator));  

     } 
     else if(message=="ask a question"){
       context.simpledb.roomleveldata.state="nlp_handler";
       context.sendResponse("Hey,What would you like to ask us?");  

     }
     else{
      var tasksforbot={
        "type": "survey",
        "question": "Below are the few things you can ask me",
        "msgid": "tasks_101",
        "options": [
        "Product Info",
        "Locate Branch/Atm",
        "Ask a question" 
        ]
      };
      MyMessageHandler(botname, contextobj, "Sorry, can you tell me again?", context, function (data) {
        if (data) {
          context.sendResponse(JSON.stringify(tasksforbot));
        }
      });
    }
  }
  else if(context.simpledb.roomleveldata.state=="product_info"){
   if(message=="deposit schemes"){
   
    context.simpledb.roomleveldata.state="deposit_forms";
    context.sendResponse(JSON.stringify(deposit_corousel));
  }

  else if(message=="loan schemes"){
    
    context.simpledb.roomleveldata.state="loan_forms";
    context.sendResponse(JSON.stringify(loan_carousel));

  }
  else{
   var product={
    "type": "survey",
    "question": "Select a product to know about it",
    "msgid": "products_201",
    "options": [
    "Deposit Schemes",
    "Loan Schemes"
    ]
  };
  MyMessageHandler(botname, contextobj, "Sorry, can you tell me again?", context, function (data) {
    if (data) {
      context.sendResponse(JSON.stringify(product));
    }
  });
  }
  }
  else if(context.simpledb.roomleveldata.state=="deposit_forms"){
    if(message=="know more 1"){
      var final_msg="1. Benefits of Recurring Deposit as well as Cumulative Deposit\n2. Attractive Interest Rates\n3. Total Deposit Period - Min.12 Months. Max.18 Years.\n4. Scheme is in two types namely -\n(a) Shubhashish Recurring and Reinvestment Deposit\n(b) Shubhashish Recurring Deposit\n* Pl.contact nearest branch for more information.";
       MyMessageHandler(botname, contextobj,final_msg, context, function (data) {
       if (data) {
        context.simpledb.roomleveldata.state="main_apply";
        context.sendResponse(JSON.stringify(apply_main));
        //context.sendResponse(JSON.stringify(deposit_corousel));
        }
      });
    }
    else if(message=="know more 2"){
       var final_msg="1. Earn Interest of Fixed Deposit\n2. Get Flexibility of Saving account options\n3. Invest Minimum 25,000/-\n4. Get Attractive Interest\n5. No Penal Interest for Before Maturity\n6. Nomination facility available";
       MyMessageHandler(botname, contextobj,final_msg, context, function (data) {
       if (data) {
        context.simpledb.roomleveldata.state="main_apply";
        context.sendResponse(JSON.stringify(apply_main));
        //context.sendResponse(JSON.stringify(deposit_corousel));
        }
      });

    }
    else if(message=="know more 3"){
       var final_msg="This is an ideal plan to cultivate the habit of regular savings. Monthly regular saving builds, a good corpus to provide for your short Term as well as long Term financial requirements\n*Loan available up to 85% of the balance outstanding in deposit account.\n*Nomination facility available.";
       MyMessageHandler(botname, contextobj,final_msg, context, function (data) {
       if (data) {
        context.simpledb.roomleveldata.state="main_apply";
        context.sendResponse(JSON.stringify(apply_main));
        //context.sendResponse(JSON.stringify(deposit_corousel));
        }
      });
      
    }
    else if(message=="know more 4"){
       var final_msg="A unique scheme with automatic renewal facility and dual benefits of Saving and Fixed Deposit Account.\n*Minimum Deposit Amount 5,000/-\n*Minimum withdrawal and Deposit should be of 1,000/- of in multiple of 1,000/-.\n*Tenure of Deposit - 45 Days\n*Nomination facility available.\n\nPayment of  Interest\n*Facility of Transfer to Savings / Current Account available\n*Facility of Cumulative Interest also available\n\nWho can deposit\n*Individuals, Partnership firms, Proprietory firm, Limited Company. H.U.F.\n\nLoan\n*90 % Loan facility available";
       MyMessageHandler(botname, contextobj,final_msg, context, function (data) {
       if (data) {
        context.simpledb.roomleveldata.state="main_apply";
        context.sendResponse(JSON.stringify(apply_main));
        //context.sendResponse(JSON.stringify(deposit_corousel));
        }
      });
      
    }
    else{
      MyMessageHandler(botname, contextobj, "Sorry, can you tell me again?", context, function (data) {
    if (data) {
      context.sendResponse(JSON.stringify(deposit_corousel));
    }
  });
    }
  }

  else if(context.simpledb.roomleveldata.state=="loan_forms"){
      if(message=="know more 1"){
      var final_msg="Loan Amount  : Maximum 30 Lacs for Mumbai, Pune & P.C.M.C. area & 20 Lacs for other areas\nRate of Interest : 14%\nPeriod Of Repayment : 7 years (Max) with moratorium facility\nGuarantor  : One only\nEligibility  : Fresher / Serviceman with professional Degree Holder\nPurpose Of Loan  : For Purchase of Office premises, Furniture for procuring professional equipment\'s (Except Vehicle)\nApplication Contribution: 5% of total project cost\nSeed Cap Loan  : 20% of project cost\nTerms Loan  : 75% of project cost";
       MyMessageHandler(botname, contextobj,final_msg, context, function (data) {
       if (data) {
        context.simpledb.roomleveldata.state="main_apply";
        context.sendResponse(JSON.stringify(apply_main));
        //context.sendResponse(JSON.stringify(deposit_corousel));
        }
      });
    }
    else if(message=="know more 2"){
       var final_msg="Rate of Interest : 12%\nGuarantor : No\nMembership : Minimum 1,000 only\nDocuments : Simple\nWho can Apply : Individual only";
       MyMessageHandler(botname, contextobj,final_msg, context, function (data) {
       if (data) {
        context.simpledb.roomleveldata.state="main_apply";
        context.sendResponse(JSON.stringify(apply_main));
        //context.sendResponse(JSON.stringify(deposit_corousel));
        }
      });

    }
    else if(message=="know more 3"){
       var final_msg="For Foreign Travel upto 1,00,000/-\nRate of Interest: Click here for Interest Rate\nPeriod  : 3 Years\nMargin  : Domestic - 15% of total expenses; Foreign - 30 % of total expenses\nGuarantor : Two\nRepayment : By Post Dated Cheque Only\nSecurity : Collateral - (For foreign tour only)\nDocuments : \n*Loan Application\n*Latest Income Proof of Applicant \n*PAN Card of Applicant \n*Address Proof of Applicant\n*Photograph of Applicant \n*Quotation for expenses\n*Copy of Passport / Visa";
       MyMessageHandler(botname, contextobj,final_msg, context, function (data) {
       if (data) {
        context.simpledb.roomleveldata.state="main_apply";
        context.sendResponse(JSON.stringify(apply_main));
        //context.sendResponse(JSON.stringify(deposit_corousel));
        }
      });

    }
     else{
      MyMessageHandler(botname, contextobj, "Sorry, can you tell me again?", context, function (data) {
    if (data) {
      context.sendResponse(JSON.stringify(deposit_corousel));
    }
  });
    }
  }
  else if(context.simpledb.roomleveldata.state=="branch_locator"){
    if(message=="branch location"){
     context.simpledb.roomleveldata.state="bank_locations";
     context.sendResponse(JSON.stringify(bank_location_corousel));
    }
    else if(message=="atm"){
      context.simpledb.roomleveldata.state="bank_atm";
     context.sendResponse(JSON.stringify(bank_atm_carousel));
    }
    else{
    var branch_locator={
         "type": "survey",
         "question": "Branch Locator",
         "msgid": "branch_locator_301",
         "options": [
         "Branch Location",
         "ATM" 
         ]
       }

    MyMessageHandler(botname, contextobj, "Sorry, can you tell me again?", context, function (data) {
    if (data) {
      context.sendResponse(JSON.stringify(branch_locator));
    }
  });
    }

  }
  else if( context.simpledb.roomleveldata.state=="bank_locations" ||  context.simpledb.roomleveldata.state=="bank_atm"){
    
     if(message.includes("know more")){
       var final_msg="To know more about Janta Sahkari Bank you can go through the link \n https://www.janatabankpune.com/";
       MyMessageHandler(botname, contextobj,final_msg, context, function (data) {
          if (data) {
              var main={
         "type": "quick_reply",
         "content": {
          "type": "text",
          "text": "  "
       },
        "msgid": "main_apply_222",
         "options": [
          "Main menu",
      ]
        }
        context.simpledb.roomleveldata.state="main_apply";
        context.sendResponse(JSON.stringify(main));
        //context.sendResponse(JSON.stringify(deposit_corousel));
        }
      });
      
    }
    else{
      MyMessageHandler(botname, contextobj, "Sorry, can you tell me again?", context, function (data) {
    if (data) {
      context.sendResponse(JSON.stringify(deposit_corousel));
    }
  });
    }


  }
  else if(context.simpledb.roomleveldata.state=="main_apply"){
    if(message=="main menu"){
       var tasksforbot={
       "type": "survey",
       "question": "Below are the few things you can ask me",
       "msgid": "tasks_101",
       "options": [
       "Product Info",
       "Locate Branch/Atm",
       "Ask a question" 
       ]
     } ;
     context.sendResponse(JSON.stringify(tasksforbot)); 

    } 
     else if(message=="apply now"){
        var branch_locator={
         "type": "survey",
         "question": "Branch Locator",
         "msgid": "branch_locator_301",
         "options": [
         "Branch Location",
         "ATM" 
         ]
       }
       context.simpledb.roomleveldata.state="branch_locator";
       context.sendResponse(JSON.stringify(branch_locator));  
     }
  }
  else if(context.simpledb.roomleveldata.state=="nlp_handler"){

    if(message=="ask a question"){
       context.simpledb.roomleveldata.state="nlp_handler";
       context.sendResponse("Hey,What would you like to ask us?");  
    }
    else{
   sendMessageToApiAi({
    message : event.message,
    sessionId : new Date().getTime() +'api',
    nlpToken : nlpToken,
    callback : function(res){
              //Sample response from apiai here.
              context.sendResponse(JSON.parse(res).result.fulfillment.speech);
            }
          },context);
  }
}
  }

  function sendMessageToApiAi(options,botcontext) {
      var message = options.message; // Mandatory
      var sessionId = options.sessionId || ""; // optinal
      var callback = options.callback;
      if (!(callback && typeof callback == 'function')) {
       return botcontext.sendResponse("ERROR : type of options.callback should be function and its Mandatory");
     }
     var nlpToken = options.nlpToken;

     if (!nlpToken) {
       if (!botcontext.simpledb.botleveldata.config || !botcontext.simpledb.botleveldata.config.nlpToken) {
         return botcontext.sendResponse("ERROR : token not set. Please set Api.ai Token to options.nlpToken or context.simpledb.botleveldata.config.nlpToken");
       } else {
         nlpToken = botcontext.simpledb.botleveldata.config.nlpToken;
       }
     }
     var query = '?v=20150910&query='+ encodeURIComponent(message) +'&sessionId='+sessionId+'&timezone=Asia/Calcutta&lang=en    '
     var apiurl = "https://api.api.ai/api/query"+query;
     var headers = { "Authorization": "Bearer " + nlpToken};
     botcontext.simplehttp.makeGet(apiurl, headers, function(context, event) {
       if (event.getresp) {
         callback(event.getresp);
       } else {
         callback({})
       }
     });
   }

   /** Functions declared below are required **/
   function EventHandler(context, event) {
    var botname = event.botname;
      var contextobj = JSON.stringify(event.contextobj);
     context.simpledb.roomleveldata["state"]="start_msg";
     var tasksforbot={
       "type": "survey",
       "question": "Below are the few things you can ask me",
       "msgid": "tasks_101",
       "options": [
       "Product Info",
       "Locate Branch/Atm",
       "Ask a question" 
       ]
     }  
     MyMessageHandler(botname, contextobj, "Hi, I am the Janata Sahakari Bank bot! I will be your personal assistant", context, function (data) {
      if (data) {
        context.sendResponse(JSON.stringify(tasksforbot));
      }
    });
   }


   function MyMessageHandler(botname, contextobj, botmessage, context, callback) {
    var url = "http://api.gupshup.io/sm/api/bot/" + botname + "/msg";
    var header = {
      "Content-Type": "application/x-www-form-urlencoded"
    };
    var body = "apikey=4825b60b09ff46e5c6c104e0701cbd50&botname=" + botname + "&context=" + contextobj + "&message=" + encodeURI(botmessage);
      // context.simplehttp.makePost(url,body,header);
      context.simplehttp.makePost(url, body, header, function (context, event) {
          //context.console.log(event.message);
          return callback(event.message);
        });

    }

    function HttpResponseHandler(context, event) {
      // if(event.geturl === "http://ip-api.com/json")
      context.sendResponse(event.getresp);
    }

    function DbGetHandler(context, event) {
      context.sendResponse("testdbput keyword was last get by:" + event.dbval);
    }

    function DbPutHandler(context, event) {
      context.sendResponse("testdbput keyword was last put by:" + event.dbval);
    }

